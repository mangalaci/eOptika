DROP TABLE IF EXISTS BASE_01_TABLE;
CREATE TABLE IF NOT EXISTS BASE_01_TABLE LIKE BASE_00i_TABLE;
ALTER TABLE `BASE_01_TABLE` ADD `crm_id` BIGINT(20) NOT NULL DEFAULT 0;

INSERT INTO BASE_01_TABLE
SELECT DISTINCT b.*, e.crm_id
FROM BASE_00i_TABLE AS b LEFT JOIN USER_14_email_deduplicated AS e
ON b.related_email_clean = e.related_email_clean;
DROP TABLE IF EXISTS BASE_02_TABLE;

DROP TABLE IF EXISTS BASE_02_TABLE;
CREATE TABLE IF NOT EXISTS BASE_02_TABLE LIKE BASE_01_TABLE;
ALTER TABLE `BASE_02_TABLE` ADD `crm_id_2` BIGINT(20) NOT NULL DEFAULT 0;

INSERT INTO BASE_02_TABLE
SELECT b.*, e.user_id as crm_id_2
FROM BASE_01_TABLE AS b LEFT JOIN USER_07_matching_emails_plus_ID AS e
ON b.shipping_name_clean = e.shipping_name_clean
AND b.billing_zip_code = e.billing_zip_code;

DROP TABLE IF EXISTS BASE_03_TABLE;
CREATE TABLE IF NOT EXISTS BASE_03_TABLE LIKE BASE_02_TABLE;
ALTER TABLE `BASE_03_TABLE` ADD `crm_id_3` BIGINT(20) NOT NULL DEFAULT 0;
ALTER TABLE `BASE_03_TABLE` ADD `user_id` BIGINT(20);

INSERT INTO BASE_03_TABLE
SELECT b.*, e.user_id as crm_id_3, COALESCE(b.crm_id,COALESCE(b.crm_id_2,e.user_id)) as user_id
FROM BASE_02_TABLE AS b LEFT JOIN USER_09_non_matching_emails AS e
ON b.shipping_name_clean = e.shipping_name_clean
AND b.billing_zip_code = e.billing_zip_code;

ALTER TABLE BASE_03_TABLE DROP crm_id;
ALTER TABLE BASE_03_TABLE DROP crm_id_2;
ALTER TABLE BASE_03_TABLE DROP crm_id_3;